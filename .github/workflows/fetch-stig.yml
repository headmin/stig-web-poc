name: Fetch STIG Data

on:
  workflow_dispatch:
    inputs:
      stig_slug:
        description: 'STIG slug (e.g., microsoft-windows-11-security-technical-implementation-guide)'
        required: true
        default: 'microsoft-windows-11-security-technical-implementation-guide'
      commit_results:
        description: 'Commit results to repo'
        type: boolean
        default: false

jobs:
  fetch-stig:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install httpx

      - name: Fetch STIG data from stigviewer.com
        id: fetch
        run: |
          cd scripts
          python fetch_stig.py --slug "${{ github.event.inputs.stig_slug }}" -o ../microsoft-windows-11-security-technical-implementation-guide.json || true
          
          # Check if file exists (may be pre-existing or newly created)
          if [ -f ../microsoft-windows-11-security-technical-implementation-guide.json ]; then
            SIZE=$(stat -c%s ../microsoft-windows-11-security-technical-implementation-guide.json 2>/dev/null || stat -f%z ../microsoft-windows-11-security-technical-implementation-guide.json)
            if [ "$SIZE" -gt 1000 ]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "[OK] STIG data available (${SIZE} bytes)"
            else
              echo "status=failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Show manual instructions if fetch failed
        if: steps.fetch.outputs.status == 'failed'
        run: |
          echo "============================================"
          echo "STIG data must be updated manually:"
          echo "============================================"
          echo ""
          echo "1. Go to https://public.cyber.mil/stigs/downloads/"
          echo "2. Search for 'Windows 11'"
          echo "3. Download the ZIP file"
          echo "4. Extract the *_Manual-xccdf.xml file"
          echo "5. Run locally:"
          echo "   python scripts/fetch_stig.py --xccdf path/to/xccdf.xml -o microsoft-windows-11-security-technical-implementation-guide.json"
          echo "6. Commit and push the updated JSON file"
          echo ""
          echo "============================================"

      - name: Upload artifact
        if: steps.fetch.outputs.status == 'success' && !env.ACT
        uses: actions/upload-artifact@v4
        with:
          name: stig-data
          path: microsoft-windows-11-security-technical-implementation-guide.json

      - name: Commit results
        if: steps.fetch.outputs.status == 'success' && github.event.inputs.commit_results == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add microsoft-windows-11-security-technical-implementation-guide.json
          git diff --staged --quiet || git commit -m "Update STIG data [skip ci]"
          git push
